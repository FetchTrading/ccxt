"use strict";const e=require("./base/Exchange"),{ExchangeError:t,ExchangeNotAvailable:i,AuthenticationError:s,InvalidOrder:r,InsufficientFunds:a,OrderNotFound:o,DDoSProtection:n,PermissionDenied:d}=require("./base/errors");module.exports=class extends e{describe(){return this.deepExtend(super.describe(),{id:"bittrex",name:"Bittrex",countries:"US",version:"v1.1",rateLimit:1500,has:{CORS:!0,createMarketOrder:!1,fetchDepositAddress:!0,fetchClosedOrders:!0,fetchCurrencies:!0,fetchMyTrades:!1,fetchOHLCV:!0,fetchOrder:!0,fetchOpenOrders:!0,fetchTickers:!0,withdraw:!0},timeframes:{"1m":"oneMin","5m":"fiveMin","30m":"thirtyMin","1h":"hour","1d":"day"},urls:{logo:"https://user-images.githubusercontent.com/1294454/27766352-cf0b3c26-5ed5-11e7-82b7-f3826b7a97d8.jpg",api:{public:"https://bittrex.com/api",account:"https://bittrex.com/api",market:"https://bittrex.com/api",v2:"https://bittrex.com/api/v2.0/pub"},www:"https://bittrex.com",doc:["https://bittrex.com/Home/Api","https://www.npmjs.org/package/node.bittrex.api"],fees:["https://bittrex.com/Fees","https://support.bittrex.com/hc/en-us/articles/115000199651-What-fees-does-Bittrex-charge-"]},api:{v2:{get:["currencies/GetBTCPrice","market/GetTicks","market/GetLatestTick","Markets/GetMarketSummaries","market/GetLatestTick"]},public:{get:["currencies","markethistory","markets","marketsummaries","marketsummary","orderbook","ticker"]},account:{get:["balance","balances","depositaddress","deposithistory","order","orders","orderhistory","withdrawalhistory","withdraw"]},market:{get:["buylimit","buymarket","cancel","openorders","selllimit","sellmarket"]}},fees:{trading:{tierBased:!1,percentage:!0,maker:.0025,taker:.0025},funding:{tierBased:!1,percentage:!1,withdraw:{BTC:.001,LTC:.01,DOGE:2,VTC:.02,PPC:.02,FTC:.2,RDD:2,NXT:2,DASH:.002,POT:.002},deposit:{BTC:0,LTC:0,DOGE:0,VTC:0,PPC:0,FTC:0,RDD:0,NXT:0,DASH:0,POT:0}}},exceptions:{APISIGN_NOT_PROVIDED:s,INVALID_SIGNATURE:s,INVALID_CURRENCY:t,INVALID_PERMISSION:s,INSUFFICIENT_FUNDS:a,QUANTITY_NOT_PROVIDED:r,MIN_TRADE_REQUIREMENT_NOT_MET:r,ORDER_NOT_OPEN:r,INVALID_ORDER:r,UUID_INVALID:o,RATE_NOT_PROVIDED:r,WHITELIST_VIOLATION_IP:d},options:{parseOrderStatus:!1,hasAlreadyAuthenticatedSuccessfully:!1}})}costToPrecision(e,t){return this.truncate(parseFloat(t),this.markets[e].precision.price)}feeToPrecision(e,t){return this.truncate(parseFloat(t),this.markets[e].precision.price)}async fetchMarkets(){let e=await this.v2GetMarketsGetMarketSummaries(),t=[];for(let i=0;i<e.result.length;i++){let s=e.result[i].Market,r=s.MarketName,a=s.MarketCurrency,o=s.BaseCurrency,n=this.commonCurrencyCode(a),d=this.commonCurrencyCode(o),h=n+"/"+d,l={amount:8,price:8},c=s.IsActive||"true"===s.IsActive;t.push({id:r,symbol:h,base:n,quote:d,baseId:a,quoteId:o,active:c,info:s,precision:l,limits:{amount:{min:s.MinTradeSize,max:void 0},price:{min:Math.pow(10,-l.price),max:void 0}}})}return t}async fetchBalance(e={}){await this.loadMarkets();let t=(await this.accountGetBalances(e)).result,i={info:t},s=this.indexBy(t,"Currency"),r=Object.keys(s);for(let e=0;e<r.length;e++){let t=r[e],a=this.commonCurrencyCode(t),o=this.account(),n=s[t],d=parseFloat(n.Available),h=parseFloat(n.Balance),l=h-d;o.free=d,o.used=l,o.total=h,i[a]=o}return this.parseBalance(i)}async fetchOrderBook(e,t,i={}){await this.loadMarkets();let s=await this.publicGetOrderbook(this.extend({market:this.marketId(e),type:"both"},i)),r=s.result;return"type"in i&&("buy"===i.type?r={buy:s.result,sell:[]}:"sell"===i.type&&(r={buy:[],sell:s.result})),this.parseOrderBook(r,void 0,"buy","sell","Rate","Quantity")}parseTicker(e,t){let i=this.safeString(e,"TimeStamp"),s=void 0;"string"==typeof i&&i.length>0&&(i=this.parse8601(i),s=this.iso8601(i));let r=void 0;t&&(r=t.symbol);let a=this.safeFloat(e,"PrevDay"),o=this.safeFloat(e,"Last"),n=void 0,d=void 0;return void 0!==o&&void 0!==a&&(n=o-a,a>0&&(d=n/a*100)),{symbol:r,timestamp:i,datetime:s,high:this.safeFloat(e,"High"),low:this.safeFloat(e,"Low"),bid:this.safeFloat(e,"Bid"),bidVolume:void 0,ask:this.safeFloat(e,"Ask"),askVolume:void 0,vwap:void 0,open:void 0,close:o,last:o,previousClose:void 0,change:n,percentage:d,average:void 0,baseVolume:this.safeFloat(e,"Volume"),quoteVolume:this.safeFloat(e,"BaseVolume"),info:e}}async fetchCurrencies(e={}){let t=(await this.publicGetCurrencies(e)).result,i={};for(let e=0;e<t.length;e++){let s=t[e],r=s.Currency,a=this.commonCurrencyCode(r),o=8,n=this.safeValue(s,"BaseAddress");i[a]={id:r,code:a,address:n,info:s,type:s.CoinType,name:s.CurrencyLong,active:s.IsActive,status:"ok",fee:this.safeFloat(s,"TxFee"),precision:o,limits:{amount:{min:Math.pow(10,-o),max:Math.pow(10,o)},price:{min:Math.pow(10,-o),max:Math.pow(10,o)},cost:{min:void 0,max:void 0},withdraw:{min:s.TxFee,max:Math.pow(10,o)}}}}return i}async fetchTickers(e,t={}){await this.loadMarkets();let i=(await this.publicGetMarketsummaries(t)).result,s={};for(let e=0;e<i.length;e++){let t=i[e],r=t.MarketName,a=void 0,o=r;s[o=r in this.markets_by_id?(a=this.markets_by_id[r]).symbol:this.parseSymbol(r)]=this.parseTicker(t,a)}return s}async fetchTicker(e,t={}){await this.loadMarkets();let i=this.market(e),s=(await this.publicGetMarketsummary(this.extend({market:i.id},t))).result[0];return this.parseTicker(s,i)}parseTrade(e,t){let i=this.parse8601(e.TimeStamp+"+00:00"),s=void 0;"BUY"===e.OrderType?s="buy":"SELL"===e.OrderType&&(s="sell");let r=void 0;return"Id"in e&&(r=e.Id.toString()),{id:r,info:e,timestamp:i,datetime:this.iso8601(i),symbol:t.symbol,type:"limit",side:s,price:this.safeFloat(e,"Price"),amount:this.safeFloat(e,"Quantity")}}async fetchTrades(e,i,s,r={}){await this.loadMarkets();let a=this.market(e),o=await this.publicGetMarkethistory(this.extend({market:a.id},r));if("result"in o&&void 0!==o.result)return this.parseTrades(o.result,a,i,s);throw new t(this.id+" fetchTrades() returned undefined response")}parseOHLCV(e,t,i="1d",s,r){return[this.parse8601(e.T+"+00:00"),e.O,e.H,e.L,e.C,e.V]}async fetchOHLCV(e,i="1m",s,r,a={}){await this.loadMarkets();let o=this.market(e),n={tickInterval:this.timeframes[i],marketName:o.id},d=await this.v2GetMarketGetTicks(this.extend(n,a));if("result"in d&&d.result)return this.parseOHLCVs(d.result,o,i,s,r);throw new t(this.id+" returned an empty or unrecognized response: "+this.json(d))}async fetchOpenOrders(e,t,i,s={}){await this.loadMarkets();let r={},a=void 0;e&&(a=this.market(e),r.market=a.id);let o=await this.marketGetOpenorders(this.extend(r,s)),n=this.parseOrders(o.result,a,t,i);return this.filterBySymbol(n,e)}async createOrder(e,i,s,r,a,o={}){if("limit"!==i)throw new t(this.id+" allows limit orders only");await this.loadMarkets();let n=this.market(e),d="marketGet"+this.capitalize(s)+i,h={market:n.id,quantity:this.amountToPrecision(e,r),rate:this.priceToPrecision(e,a)},l=await this[d](this.extend(h,o)),c=this.getOrderIdField();return{info:l,id:l.result[c],symbol:e,type:i,side:s,status:"open"}}getOrderIdField(){return"uuid"}async cancelOrder(e,t,i={}){await this.loadMarkets();let s={};s[this.getOrderIdField()]=e;let r=await this.marketGetCancel(this.extend(s,i));return this.parseOrder(r)}parseSymbol(e){let[t,i]=e.split("-");return(i=this.commonCurrencyCode(i))+"/"+(t=this.commonCurrencyCode(t))}parseOrder(e,t){let i=this.safeString(e,"OrderType");void 0===i&&(i=this.safeString(e,"Type"));let s="LIMIT_SELL"===i||"SELL"===i;("LIMIT_BUY"===i||"BUY"===i)&&(i="buy"),s&&(i="sell");let r=void 0;"Opened"in e&&e.Opened&&(r="open"),"Closed"in e&&e.Closed&&(r="closed"),"CancelInitiated"in e&&e.CancelInitiated&&(r="canceled"),"Status"in e&&this.options.parseOrderStatus&&(r=this.parseOrderStatus(e.Status));let a=void 0;if("Exchange"in e){let i=e.Exchange;a=i in this.markets_by_id?(t=this.markets_by_id[i]).symbol:this.parseSymbol(i)}else void 0!==t&&(a=t.symbol);let o=void 0;"Opened"in e&&(o=this.parse8601(e.Opened+"+00:00")),"Created"in e&&(o=this.parse8601(e.Created+"+00:00"));let n=void 0;"TimeStamp"in e&&void 0!==e.TimeStamp&&(n=this.parse8601(e.TimeStamp+"+00:00")),"Closed"in e&&void 0!==e.Closed&&(n=this.parse8601(e.Closed+"+00:00")),void 0===o&&(o=n);let d=void 0!==o?this.iso8601(o):void 0,h=void 0,l=void 0;if("Commission"in e?l="Commission":"CommissionPaid"in e&&(l="CommissionPaid"),l)if(h={cost:parseFloat(e[l])},void 0!==t)h.currency=t.quote;else if(a){let e=a.split("/")[1];e in this.currencies_by_id?h.currency=this.currencies_by_id[e].code:h.currency=this.commonCurrencyCode(e)}let c=this.safeFloat(e,"Limit"),u=this.safeFloat(e,"Price"),m=this.safeFloat(e,"Quantity"),p=this.safeFloat(e,"QuantityRemaining"),y=void 0;void 0!==m&&void 0!==p&&(y=m-p),u||c&&m&&(u=c*m),c||u&&y&&(c=u/y);let f=this.safeFloat(e,"PricePerUnit"),k=this.safeString(e,"OrderUuid");return void 0===k&&(k=this.safeString(e,"OrderId")),{info:e,id:k,timestamp:o,datetime:d,lastTradeTimestamp:n,symbol:a,type:"limit",side:i,price:c,cost:u,average:f,amount:m,filled:y,remaining:p,status:r,fee:h}}async fetchOrder(e,t,i={}){await this.loadMarkets();let s=void 0;try{let t=this.getOrderIdField(),r={};r[t]=e,s=await this.accountGetOrder(this.extend(r,i))}catch(e){if(this.last_json_response){if("UUID_INVALID"===this.safeString(this.last_json_response,"message"))throw new o(this.id+" fetchOrder() error: "+this.last_http_response)}throw e}if(!s.result)throw new o(this.id+" order "+e+" not found");return this.parseOrder(s.result)}async fetchClosedOrders(e,t,i,s={}){await this.loadMarkets();let r={},a=void 0;e&&(a=this.market(e),r.market=a.id);let o=await this.accountGetOrderhistory(this.extend(r,s)),n=this.parseOrders(o.result,a,t,i);return e?this.filterBySymbol(n,e):n}async fetchDepositAddress(e,t={}){await this.loadMarkets();let i=this.currency(e),s=await this.accountGetDepositaddress(this.extend({currency:i.id},t)),r=this.safeString(s.result,"Address"),a=this.safeString(s,"message"),o="ok";r&&"ADDRESS_GENERATING"!==a||(o="pending");let n=void 0;return"XRP"!==e&&"XLM"!==e||(n=r,r=i.address),this.checkAddress(r),{currency:e,address:r,tag:n,status:o,info:s}}async withdraw(e,t,i,s,r={}){this.checkAddress(i),await this.loadMarkets();let a={currency:this.currency(e).id,quantity:t,address:i};s&&(a.paymentid=s);let o=await this.accountGetWithdraw(this.extend(a,r)),n=void 0;return"result"in o&&"uuid"in o.result&&(n=o.result.uuid),{info:o,id:n}}sign(e,t="public",i="GET",s={},r,a){let o=this.urls.api[t]+"/";if("v2"!==t&&(o+=this.version+"/"),"public"===t)o+=t+"/"+i.toLowerCase()+e,Object.keys(s).length&&(o+="?"+this.urlencode(s));else if("v2"===t)o+=e,Object.keys(s).length&&(o+="?"+this.urlencode(s));else{this.checkRequiredCredentials();let a=this.nonce();o+=t+"/",("account"===t&&"withdraw"!==e||"openorders"===e)&&(o+=i.toLowerCase()),o+=e+"?"+this.urlencode(this.extend({nonce:a,apikey:this.apiKey},s)),r={apisign:this.hmac(this.encode(o),this.encode(this.secret),"sha512")}}return{url:o,method:i,body:a,headers:r}}handleErrors(e,a,d,h,l,c){if("{"===c[0]){let e=JSON.parse(c),a=this.safeValue(e,"success");if(void 0===a)throw new t(this.id+": malformed response: "+this.json(e));if("string"==typeof a&&(a="true"===a),!a){const a=this.safeString(e,"message"),h=this.id+" "+this.json(e),l=this.exceptions;if("APIKEY_INVALID"===a)throw this.options.hasAlreadyAuthenticatedSuccessfully?new n(h):new s(h);if("DUST_TRADE_DISALLOWED_MIN_VALUE_50K_SAT"===a)throw new r(this.id+" order cost should be over 50k satoshi "+this.json(e));if("INVALID_ORDER"===a){let t="cancel";if(d.indexOf(t)>=0){let t=d.split("&"),i=void 0;for(let e=0;e<t.length;e++){let s=t[e].split("=");if("uuid"===s[0]){i=s[1];break}}throw new o(void 0!==i?this.id+" cancelOrder "+i+" "+this.json(e):this.id+" cancelOrder "+this.json(e))}}if(a in l)throw new l[a](h);if(void 0!==a){if(a.indexOf("throttled. Try again")>=0)throw new n(h);if(a.indexOf("problem")>=0)throw new i(h)}throw new t(h)}}}async request(e,t="public",i="GET",s={},r,a){let o=await this.fetch2(e,t,i,s,r,a);return"account"!==t&&"market"!==t||(this.options.hasAlreadyAuthenticatedSuccessfully=!0),o}};
//# sourceMappingURL=bittrex.js.map