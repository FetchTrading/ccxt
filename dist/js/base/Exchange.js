"use strict";const e=require("./functions"),t=require("./Market"),{isNode:s,keys:i,values:r,deepExtend:n,extend:o,flatten:a,unique:h,indexBy:c,sortBy:d,groupBy:l,aggregate:u,uuid:m,unCamelCase:f,precisionFromString:p,throttle:k,capitalize:g,now:O,sleep:b,timeout:v,TimedOut:w,buildOHLCVC:C}=e,{ExchangeError:T,InvalidAddress:L,NotSupported:B,AuthenticationError:x,DDoSProtection:S,RequestTimeout:A,ExchangeNotAvailable:j}=require("./errors"),{DECIMAL_PLACES:M}=e.precisionConstants,_=s?require("fetch-ponyfill")().fetch:fetch,R=void 0;module.exports=class{getMarket(e){this.marketClasses||(this.marketClasses={});let s=this.marketClasses[e];return s||(s=new t(this,e),this.marketClasses[e]=s,s)}describe(){return{id:void 0,name:void 0,countries:void 0,enableRateLimit:!1,rateLimit:2e3,has:{CORS:!1,publicAPI:!0,privateAPI:!0,cancelOrder:!0,cancelOrders:!1,createDepositAddress:!1,createOrder:!0,createMarketOrder:!0,createLimitOrder:!0,deposit:!1,editOrder:"emulated",fetchBalance:!0,fetchBidsAsks:!1,fetchClosedOrders:!1,fetchCurrencies:!1,fetchDepositAddress:!1,fetchFundingFees:!1,fetchL2OrderBook:!0,fetchMarkets:!0,fetchMyTrades:!1,fetchOHLCV:"emulated",fetchOpenOrders:!1,fetchOrder:!1,fetchOrderBook:!0,fetchOrderBooks:!1,fetchOrders:!1,fetchTicker:!0,fetchTickers:!1,fetchTrades:!0,fetchTradingFees:!1,fetchTradingLimits:!1,startInstantTransaction:!1,withdraw:!1},urls:{logo:void 0,api:void 0,www:void 0,doc:void 0,fees:void 0},api:void 0,requiredCredentials:{apiKey:!0,secret:!0,uid:!1,login:!1,password:!1,twofa:!1,ethereumNodeAddress:!1},markets:void 0,currencies:{},timeframes:void 0,fees:{trading:{tierBased:void 0,percentage:void 0,taker:void 0,maker:void 0},funding:{tierBased:void 0,percentage:void 0,withdraw:{},deposit:{}}},parseJsonResponse:!0,skipJsonOnStatusCodes:[],exceptions:void 0,dontGetUsedBalanceFromStaleCache:!1,commonCurrencies:{XBT:"BTC",BCC:"BCH",DRK:"DASH"},precisionMode:M}}constructor(t={}){Object.assign(this,e,{encode:e=>e,decode:e=>e}),s&&(this.nodeVersion=process.version.match(/\d+\.\d+.\d+/)[0]),this.options={},this.fetchOptions={},this.userAgents={chrome:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36",chrome39:"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.71 Safari/537.36"},this.headers={},this.proxy="",this.origin="*",this.iso8601=(e=>{const t=parseInt(e,10);if(!(global.isNaN(t)||t<0||t<0))try{return new Date(t).toISOString()}catch(e){return}}),this.parse8601=(e=>{if("string"==typeof e&&e&&!e.match(/^[0-9]+$/)&&!(e.indexOf("-")<0||e.indexOf(":")<0))try{const t=Date.parse(e.indexOf("+")>=0||"Z"===e.slice(-1)?e:(e+"Z").replace(/\s(\d\d):/,"T$1:"));if(global.isNaN(t))return;return t}catch(e){return}}),this.parseDate=(e=>{if("string"==typeof e&&e){if(e.indexOf("GMT")>=0)try{return Date.parse(e)}catch(e){return}return this.parse8601(e)}}),this.microseconds=(()=>1e3*O()),this.seconds=(()=>Math.floor(O()/1e3)),this.minFundingAddressLength=1,this.substituteCommonCurrencyCodes=!0,this.fetchImplementation=_,this.timeout=1e4,this.verbose=!1,this.debug=!1,this.journal="debug.json",this.userAgent=void 0,this.twofa=!1,this.apiKey=void 0,this.secret=void 0,this.uid=void 0,this.login=void 0,this.password=void 0,this.balance={},this.orderbooks={},this.tickers={},this.orders={},this.trades={},this.last_http_response=void 0,this.last_json_response=void 0,this.last_response_headers=void 0,this.arrayConcat=((e,t)=>e.concat(t));const i=(e=this)=>{if(null!==e){const t=Object.getOwnPropertyNames(e);let s=0;for(t.length;s<t.length;s++){const e=t[s];this[f(e)]=this[e]}i(Object.getPrototypeOf(e))}};i();const r=n(this.describe(),t);for(const[e,t]of Object.entries(r))this[e]=n(this[e],t);for(const e in this.has)this["has"+g(e)]=!!this.has[e];this.api&&this.defineRestApi(this.api,"request"),this.initRestRateLimiter(),this.markets&&this.setMarkets(this.markets),this.debug&&R&&R(()=>this.journal,this,Object.keys(this.has))}defaults(){return{}}nonce(){return this.seconds()}milliseconds(){return O()}encodeURIComponent(...e){return encodeURIComponent(...e)}checkRequiredCredentials(){Object.keys(this.requiredCredentials).forEach(e=>{if(this.requiredCredentials[e]&&!this[e])throw new x(this.id+" requires `"+e+"`")})}checkAddress(e){if(void 0===e)throw new L(this.id+" address is undefined");if(1===h(e).length||e.length<this.minFundingAddressLength||e.includes(" "))throw new L(this.id+" address is invalid or has less than "+this.minFundingAddressLength.toString()+' characters: "'+e.toString()+'"');return e}initRestRateLimiter(){const e=this.fetchImplementation;if(void 0===this.rateLimit)throw new Error(this.id+".rateLimit property is not configured");this.tokenBucket=this.extend({refillRate:1/this.rateLimit,delay:1,capacity:1,defaultCost:1,maxCapacity:1e3},this.tokenBucket),this.throttle=k(this.tokenBucket),this.executeRestRequest=function(t,i="GET",r,n){let o=e(t,this.extend({method:i,headers:r,body:n,agent:this.agent||null,timeout:this.timeout},this.fetchOptions)).catch(e=>{if(s)throw new j([this.id,i,t,e.type,e.message].join(" "));throw e}).then(e=>this.handleRestResponse(e,t,i,r,n));return v(this.timeout,o).catch(e=>{if(e instanceof w)throw new A(this.id+" "+i+" "+t+" request timed out ("+this.timeout+" ms)");throw e})}}defineRestApi(e,t,s={}){for(const i of Object.keys(e))for(const r of Object.keys(e[i])){let n=e[i][r];for(let e=0;e<n.length;e++){let o=n[e].trim(),a=o.split(/[^a-zA-Z0-9]/),h=r.toUpperCase(),c=r.toLowerCase(),d=this.capitalize(c),l=a.map(this.capitalize).join(""),u=a.map(e=>e.trim().toLowerCase()).filter(e=>e.length>0).join("_"),m=i+d+this.capitalize(l),f=i+"_"+c+"_"+u;"suffixes"in s&&("camelcase"in s.suffixes&&(m+=s.suffixes.camelcase),"underscore"in s.suffixes&&(f+=s.suffixes.underscore)),"underscore_suffix"in s&&(f+=s.underscoreSuffix),"camelcase_suffix"in s&&(m+=s.camelcaseSuffix);let p=async e=>this[t](o,i,h,e||{});this[m]=p,this[f]=p}}}fetch(e,t="GET",i,r){return s&&this.userAgent&&("string"==typeof this.userAgent?i=o({"User-Agent":this.userAgent},i):"object"==typeof this.userAgent&&"User-Agent"in this.userAgent&&(i=o(this.userAgent,i))),"function"==typeof this.proxy?(e=this.proxy(e),s&&(i=o({Origin:this.origin},i))):"string"==typeof this.proxy&&(this.proxy.length&&s&&(i=o({Origin:this.origin},i)),e=this.proxy+e),i=o(this.headers,i),this.verbose&&console.log("fetch:\n",this.id,t,e,"\nRequest:\n",i,"\n",r,"\n"),this.executeRestRequest(e,t,i,r)}async fetch2(e,t="public",s="GET",i={},r,n){this.enableRateLimit&&await this.throttle();const o=this.sign(e,t,s,i,r,n);return this.fetch(o.url,o.method,o.headers,o.body)}request(e,t="public",s="GET",i={},r,n){return this.fetch2(e,t,s,i,r,n)}parseJson(e,t,s,i){try{return t.length>0?JSON.parse(t):{}}catch(r){this.verbose&&console.log("parseJson:\n",this.id,i,s,e.status,"error",r,"response body:\n'"+t+"'\n");let n=void 0,o=t.match(/<title>([^<]+)/i);o&&(n=o[1].trim());const a=t.match(/offline|busy|retry|wait|unavailable|maintain|maintenance|maintenancing/i),h=t.match(/cloudflare|incapsula|overload|ddos/i);if(r instanceof SyntaxError){let t=j,r="not accessible from this location at the moment";throw a&&(r="offline, on maintenance or unreachable from this location at the moment"),h&&(t=S),new t([this.id,i,s,e.status,n,r].join(" "))}throw r}}handleErrors(e,t,s,i,r,n,o){}defaultErrorHandler(e,t,s,i){const{status:r,statusText:n}=e;if(r>=200&&r<=299)return;let o=void 0,a=t,h=t.match(/<title>([^<]+)/i);if(h&&(a=h[1].trim()),[418,429].includes(r))o=S;else if([404,409,500,501,502,520,521,522,525].includes(r))o=j;else if([400,403,405,503,530].includes(r)){t.match(/cloudflare|incapsula/i)?o=S:(o=j,a+=" (possible reasons: "+["invalid API keys","bad or old nonce","exchange is down or offline","on maintenance","DDoS protection","rate-limiting"].join(", ")+")")}else o=[408,504].includes(r)?A:[401,511].includes(r)?x:T;throw new o([this.id,i,s,r,n,a].join(" "))}handleRestResponse(e,t,s="GET",i,r){return e.text().then(i=>{let r=this.parseJsonResponse&&!this.skipJsonOnStatusCodes.includes(e.status),n=r?this.parseJson(e,i,t,s):void 0,o={};e.headers.forEach((e,t)=>{t=t.split("-").map(e=>g(e)).join("-"),o[t]=e}),this.last_response_headers=o,this.last_http_response=i,this.last_json_response=n,this.verbose&&console.log("handleRestResponse:\n",this.id,s,t,e.status,e.statusText,"\nResponse:\n",o,"\n",i,"\n");const a=[e.status,e.statusText,t,s,o,i,n];return this.handleErrors(...a),this.defaultErrorHandler(e,i,t,s),r?n:i})}setMarkets(e,t){let s=Object.values(e).map(e=>n({limits:this.limits,precision:this.precision},this.fees.trading,e));if(this.markets=n(this.markets,c(s,"symbol")),this.marketsById=c(e,"id"),this.markets_by_id=this.marketsById,this.symbols=Object.keys(this.markets).sort(),this.ids=Object.keys(this.markets_by_id).sort(),t)this.currencies=n(t,this.currencies);else{const e=s.filter(e=>"base"in e).map(e=>({id:e.baseId||e.base,numericId:void 0!==e.baseNumericId?e.baseNumericId:void 0,code:e.base,precision:e.precision?e.precision.base||e.precision.amount:8})),t=s.filter(e=>"quote"in e).map(e=>({id:e.quoteId||e.quote,numericId:void 0!==e.quoteNumericId?e.quoteNumericId:void 0,code:e.quote,precision:e.precision?e.precision.quote||e.precision.price:8})),i=e.concat(t),r=l(i,"code"),o=Object.keys(r).map(e=>r[e].reduce((e,t)=>e.precision>t.precision?e:t,r[e][0])),h=d(a(o),"code");this.currencies=n(c(h,"code"),this.currencies)}return this.currencies_by_id=c(this.currencies,"id"),this.markets}async loadMarkets(e=!1){if(!e&&this.markets)return this.markets_by_id?this.markets:this.setMarkets(this.markets);const t=await this.fetchMarkets();let s=void 0;return this.has.fetchCurrencies&&(s=await this.fetchCurrencies()),this.setMarkets(t,s)}fetchBidsAsks(e,t={}){throw new B(this.id+" fetchBidsAsks not supported yet")}async fetchOHLCVC(e,t="1m",s,i,r={}){if(!this.has.fetchTrades)throw new B(this.id+" fetchOHLCV() not supported yet");await this.loadMarkets();let n=await this.fetchTrades(e,s,i,r);return C(n,t,s,i)}async fetchOHLCV(e,t="1m",s,i,r={}){if(!this.has.fetchTrades)throw new B(this.id+" fetchOHLCV() not supported yet");await this.loadMarkets();let n=await this.fetchTrades(e,s,i,r);return C(n,t,s,i).map(e=>e.slice(0,-1))}convertTradingViewToOHLCV(e){let t=[];for(let s=0;s<e.t.length;s++)t.push([1e3*e.t[s],e.o[s],e.h[s],e.l[s],e.c[s],e.v[s]]);return t}convertOHLCVToTradingView(e){let t={t:[],o:[],h:[],l:[],c:[],v:[]};for(let s=0;s<e.length;s++)t.t.push(parseInt(e[s][0]/1e3)),t.o.push(e[s][1]),t.h.push(e[s][2]),t.l.push(e[s][3]),t.c.push(e[s][4]),t.v.push(e[s][5]);return t}fetchTickers(e,t={}){throw new B(this.id+" fetchTickers not supported yet")}purgeCachedOrders(e){const t=Object.values(this.orders).filter(t=>"open"===t.status||t.timestamp>=e);return this.orders=c(t,"id"),this.orders}fetchOrder(e,t,s={}){throw new B(this.id+" fetchOrder not supported yet")}fetchOrders(e,t,s,i={}){throw new B(this.id+" fetchOrders not supported yet")}fetchOpenOrders(e,t,s,i={}){throw new B(this.id+" fetchOpenOrders not supported yet")}fetchClosedOrders(e,t,s,i={}){throw new B(this.id+" fetchClosedOrders not supported yet")}fetchMyTrades(e,t,s,i={}){throw new B(this.id+" fetchMyTrades not supported yet")}fetchCurrencies(){throw new B(this.id+" fetchCurrencies not supported yet")}fetchMarkets(){return new Promise((e,t)=>e(Object.values(this.markets)))}async fetchOrderStatus(e,t){return(await this.fetchOrder(e,t)).status}account(){return{free:0,used:0,total:0}}commonCurrencyCode(e){return this.substituteCommonCurrencyCodes?this.safeString(this.commonCurrencies,e,e):e}currencyId(e){let t={},s=Object.keys(this.commonCurrencies);for(let e=0;e<s.length;e++){let i=s[e];t[this.commonCurrencies[i]]=i}return this.safeString(t,e,e)}currency(e){if(void 0===this.currencies)throw new T(this.id+" currencies not loaded");if("string"==typeof e&&e in this.currencies)return this.currencies[e];throw new T(this.id+" does not have currency code "+e)}findMarket(e){if(void 0===this.markets)throw new T(this.id+" markets not loaded");if("string"==typeof e){if(e in this.markets_by_id)return this.markets_by_id[e];if(e in this.markets)return this.markets[e]}return e}findSymbol(e,t){return void 0===t&&(t=this.findMarket(e)),"object"==typeof t?t.symbol:e}market(e){if(void 0===this.markets)throw new T(this.id+" markets not loaded");if("string"==typeof e&&e in this.markets)return this.markets[e];throw new T(this.id+" does not have market symbol "+e)}marketId(e){let t=this.market(e);return void 0!==t?t.id:e}marketIds(e){return e.map(e=>this.marketId(e))}symbol(e){return this.market(e).symbol||e}extractParams(e){let t=/{([\w-]+)}/g,s=[],i=t.exec(e);for(;i;)s.push(i[1]),i=t.exec(e);return s}implodeParams(e,t){for(let s in t)e=e.replace("{"+s+"}",t[s]);return e}url(e,t={}){let s=this.implodeParams(e,t),i=this.omit(t,this.extractParams(e));return Object.keys(i).length&&(s+="?"+this.urlencode(i)),s}parseBidAsk(e,t=0,s=1){return[parseFloat(e[t]),parseFloat(e[s])]}parseBidsAsks(e,t=0,s=1){return Object.values(e||[]).map(e=>this.parseBidAsk(e,t,s))}async fetchL2OrderBook(e,t,s={}){let i=await this.fetchOrderBook(e,t,s);return o(i,{bids:d(u(i.bids),0,!0),asks:d(u(i.asks),0)})}parseOrderBook(e,t,s="bids",i="asks",r=0,n=1){return{bids:d(s in e?this.parseBidsAsks(e[s],r,n):[],0,!0),asks:d(i in e?this.parseBidsAsks(e[i],r,n):[],0),timestamp:t,datetime:void 0!==t?this.iso8601(t):void 0,nonce:void 0}}getCurrencyUsedOnOpenOrders(e){return Object.values(this.orders).filter(e=>"open"===e.status).reduce((t,s)=>{let i=s.symbol,r=this.markets[i],n=s.remaining;return e===r.base&&"sell"===s.side?t+n:e===r.quote&&"buy"===s.side?t+s.price*n:t},0)}parseBalance(e){return Object.keys(this.omit(e,"info")).forEach(t=>{if(void 0===e[t].used)if(this.dontGetUsedBalanceFromStaleCache&&"open_orders"in e.info){const s=e.info.open_orders;Object.values(this.orders).filter(e=>"open"===e.status).length===s&&(e[t].used=this.getCurrencyUsedOnOpenOrders(t),e[t].total=e[t].used+e[t].free)}else e[t].used=this.getCurrencyUsedOnOpenOrders(t),e[t].total=e[t].used+e[t].free;["free","used","total"].forEach(s=>{e[s]=e[s]||{},e[s][t]=e[t][s]})}),e}async fetchPartialBalance(e,t={}){return(await this.fetchBalance(t))[e]}fetchFreeBalance(e={}){return this.fetchPartialBalance("free",e)}fetchUsedBalance(e={}){return this.fetchPartialBalance("used",e)}fetchTotalBalance(e={}){return this.fetchPartialBalance("total",e)}async loadTradingLimits(e,t=!1,s={}){if(this.has.fetchTradingLimits&&(t||!("limitsLoaded"in this.options))){let t=(await this.fetchTradingLimits(e)).limits,s=Object.keys(t);for(let e=0;e<s.length;e++){let i=s[e];this.markets[i]=this.deepExtend(this.markets[i],{limits:t[i]})}this.options.limitsLoaded=this.milliseconds()}return this.markets}filterBySinceLimit(e,t,s){return void 0!==t&&null!==t&&(e=e.filter(e=>e.timestamp>=t)),void 0!==s&&null!==s&&(e=e.slice(0,s)),e}filterBySymbolSinceLimit(e,t,s,i){const r=void 0!==t&&null!==t,n=void 0!==s&&null!==s;return(r||n)&&(e=Object.values(e).filter(e=>(!r||e.symbol===t)&&(!n||e.timestamp>=s))),void 0!==i&&null!==i&&(e=Object.values(e).slice(0,i)),e}filterByArray(e,t,s,i=!0){if(e=Object.values(e),void 0===s||null===s)return i?c(e,t):e;let r=[];for(let i=0;i<e.length;i++)s.includes(e[i][t])&&r.push(e[i]);return i?c(r,t):r}parseTrades(e,t,s,i){let r=Object.values(e||[]).map(e=>this.parseTrade(e,t));r=d(r,"timestamp");let n=void 0!==t?t.symbol:void 0;return this.filterBySymbolSinceLimit(r,n,s,i)}parseOrders(e,t,s,i){let r=Object.values(e).map(e=>this.parseOrder(e,t));r=d(r,"timestamp");let n=void 0!==t?t.symbol:void 0;return this.filterBySymbolSinceLimit(r,n,s,i)}filterBySymbol(e,t){return void 0!==t?e.filter(e=>e.symbol===t):e}parseOHLCV(e,t,s="1m",i,r){return Array.isArray(e)?e.slice(0,6):e}parseOHLCVs(e,t,s="1m",i,r){e=Object.values(e);let n=[];for(let o=0;o<e.length&&!(r&&n.length>=r);o++){let a=this.parseOHLCV(e[o],t,s,i,r);i&&a[0]<i||n.push(a)}return n}editLimitBuyOrder(e,t,...s){return this.editLimitOrder(e,t,"buy",...s)}editLimitSellOrder(e,t,...s){return this.editLimitOrder(e,t,"sell",...s)}editLimitOrder(e,t,...s){return this.editOrder(e,t,"limit",...s)}async editOrder(e,t,...s){if(!this.enableRateLimit)throw new T(this.id+" editOrder() requires enableRateLimit = true");return await this.cancelOrder(e,t),this.createOrder(t,...s)}createLimitOrder(e,...t){return this.createOrder(e,"limit",...t)}createMarketOrder(e,...t){return this.createOrder(e,"market",...t)}createLimitBuyOrder(e,...t){return this.createOrder(e,"limit","buy",...t)}createLimitSellOrder(e,...t){return this.createOrder(e,"limit","sell",...t)}createMarketBuyOrder(e,t,s={}){return this.createOrder(e,"market","buy",t,void 0,s)}createMarketSellOrder(e,t,s={}){return this.createOrder(e,"market","sell",t,void 0,s)}costToPrecision(e,t){return parseFloat(t).toFixed(this.markets[e].precision.price)}priceToPrecision(e,t){return parseFloat(t).toFixed(this.markets[e].precision.price)}amountToPrecision(e,t){return this.truncate(t,this.markets[e].precision.amount)}amountToString(e,t){return this.truncate_to_string(t,this.markets[e].precision.amount)}amountToLots(e,t){const s=this.markets[e].lot;return this.amountToPrecision(e,Math.floor(t/s)*s)}feeToPrecision(e,t){return parseFloat(t).toFixed(this.markets[e].precision.price)}calculateFee(e,t,s,i,r,n="taker",o={}){let a=this.markets[e],h=a[n],c=parseFloat(this.costToPrecision(e,i*r));return{type:n,currency:a.quote,rate:h,cost:parseFloat(this.feeToPrecision(e,h*c))}}mdy(e,t="-"){t=t||"";let s=new Date(e),i=(s.getUTCFullYear().toString(),s.getUTCMonth()+1),r=s.getUTCDate();return(i=i<10?"0"+i:i.toString())+t+(r=r<10?"0"+r:r.toString())+t+y}ymd(e,t="-"){t=t||"";let s=new Date(e),i=s.getUTCFullYear().toString(),r=s.getUTCMonth()+1,n=s.getUTCDate();return i+t+(r=r<10?"0"+r:r.toString())+t+(n=n<10?"0"+n:n.toString())}ymdhms(e,t=" "){let s=new Date(e),i=s.getUTCFullYear(),r=s.getUTCMonth()+1,n=s.getUTCDate(),o=s.getUTCHours(),a=s.getUTCMinutes(),h=s.getUTCSeconds();return i+"-"+(r=r<10?"0"+r:r)+"-"+(n=n<10?"0"+n:n)+t+(o=o<10?"0"+o:o)+":"+(a=a<10?"0"+a:a)+":"+(h=h<10?"0"+h:h)}};
//# sourceMappingURL=Exchange.js.map