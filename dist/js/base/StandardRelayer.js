"use strict";const{HttpClient:e}=require("@0xproject/connect"),{BigNumber:t}=require("@0xproject/utils"),{Web3Wrapper:s}=require("@0xproject/web3-wrapper"),r=require("./Exchange"),o=require("./TokenInfo");class n extends r{constructor(){if(super(),this.constructor===n)throw new TypeError('Abstract class "StandardRelayer" cannot be instantiated directly.')}describe(){return this.deepExtend(super.describe(),{has:{createOrder:!1,createMarketOrder:!1,createLimitOrder:!1,ethIsWeth:!0,fetchBalance:!1,fetchCurrencies:!0,fetchL2OrderBook:!1,fetchMarkets:!0,fetchOHLCV:!1,fetchOrderBook:!0,fetchTicker:!1,fetchTrades:!1,privateAPI:!1,needsEthereumNodeEndpoint:!0,is0xProtocol:!0},requiredCredentials:{ethereumNodeAddress:!0},perPage:500,networkId:1})}client(){return this.zeroXClient||(this.zeroXClient=new e(this.describe().urls.api)),this.zeroXClient}async orderbook(e){await this.loadMarkets();const t=this.markets[e];if(!t)return{timestamp:(new Date).getTime(),bids:void 0,asks:void 0,info:void 0};const[s,r]=e.split("/");let i=void 0,a=void 0;o.getFromAddress(t.info.tokenB.address).symbol===s?(i=t.info.tokenB.address,a=t.info.tokenA.address):(i=t.info.tokenA.address,a=t.info.tokenB.address);const d=await this.client().getOrderbookAsync({baseTokenAddress:i,quoteTokenAddress:a},{}),c=this.currencies[s].precision,m=this.currencies[r].precision,{bidRates:u,askRates:k}=n.sortOrderbookResponse(d,c,m),l=new Date;return{asks:k,bids:u,datetime:l.toISOString(),nonce:void 0,timestamp:l.getTime(),info:d}}async ticker(e){this.currencies?await this.loadMarkets():await Promise.all([this.loadMarkets(),this.fetchCurrencies()]);const t=this.markets[e],s=await this.client().getOrderbookAsync({baseTokenAddress:t.info.tokenA.address,quoteTokenAddress:t.info.tokenB.address}),[r,o]=e.split("/"),i=this.currencies[r].precision,a=this.currencies[o].precision,{bidRates:d,askRates:c}=n.sortOrderbookResponse(s,i,a),m=d[0],u=c[0],k=new Date;return{symbol:e,timestamp:k.getTime(),datetime:k.toISOString(),bid:m[0],bidVolume:m[1],ask:u[0],askVolume:u[1],info:s}}async listedCurrencies(){const e=await this.paginateTokenPairs(),t=new Set,s={};for(let r=0;r<e.length;r++){const{tokenA:n,tokenB:i}=e[r],a=o.getFromAddress(n.address),d=o.getFromAddress(i.address);a&&d&&(t.has(a.symbol)||(s[a.symbol]={id:a.symbol,code:a.symbol,info:n,name:a.name,active:!0,status:"ok",precision:a.decimals},t.add(a.symbol)),t.has(d.symbol)||(s[d.symbol]={id:d.symbol,code:d.symbol,info:i,name:d.name,active:!0,status:"ok",precision:d.decimals},t.add(d.symbol)))}return s}async paginateTokenPairs(){let e=1,t=[],s=await this.client().getTokenPairsAsync({page:e,perPage:this.perPage});for(t=t.concat(s);s.length&&(e++,s=await this.client().getTokenPairsAsync({page:e,perPage:this.perPage}),t=t.concat(s),!(s.length<this.perPage)););return t}async tokenPairs(){const e=await this.paginateTokenPairs(),t=[];for(let s=0;s<e.length;s++){const r=e[s],n=o.getFromAddress(r.tokenA.address),i=o.getFromAddress(r.tokenB.address);if(!n||!i)continue;const a=n.symbol,d=i.symbol,c=`${a}/${d}`;t.push({id:c,symbol:c,base:a,quote:d,active:!0,limits:{amount:{min:r.tokenA.minAmount,max:r.tokenA.maxAmount}},info:r});const m=`${d}/${a}`;t.push({id:m,symbol:m,base:d,quote:a,active:!0,limits:{amount:{min:r.tokenB.minAmount,max:r.tokenB.maxAmount}},info:r})}return t}static calculateRates(e,r,o,n){const i=e.length,a=new Array(i),d=new t(1);for(let c=0;c<i;c++){const i=e[c],{makerTokenAmount:m,takerTokenAmount:u}=i,k=s.toUnitAmount(m,r),l=s.toUnitAmount(u,o);let h=k.div(l),b=s.toUnitAmount(new t(u),o);n||(h=d.div(h),b=s.toUnitAmount(new t(m),r)),a[c]=[h.toNumber(),b.toNumber(),i]}return a}static sortOrders(e){return e.sort((e,s)=>{const r=new t(e.makerTokenAmount).div(new t(e.takerTokenAmount));return new t(s.makerTokenAmount).div(new t(s.takerTokenAmount)).comparedTo(r)})}static sortOrderbookResponse(e,t,s){const{asks:r,bids:o}=e,i=n.sortOrders(o),a=n.sortOrders(r);return{bidRates:n.calculateRates(i,s,t,!0),askRates:n.calculateRates(a,t,s,!1)}}}module.exports=n;
//# sourceMappingURL=StandardRelayer.js.map