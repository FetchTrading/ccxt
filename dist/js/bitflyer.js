"use strict";const e=require("./base/Exchange"),{ExchangeError:t,OrderNotFound:i}=require("./base/errors");module.exports=class extends e{describe(){return this.deepExtend(super.describe(),{id:"bitflyer",name:"bitFlyer",countries:"JP",version:"v1",rateLimit:1e3,has:{CORS:!1,withdraw:!0,fetchMyTrades:!0,fetchOrders:!0,fetchOrder:!0,fetchOpenOrders:"emulated",fetchClosedOrders:"emulated"},urls:{logo:"https://user-images.githubusercontent.com/1294454/28051642-56154182-660e-11e7-9b0d-6042d1e6edd8.jpg",api:"https://api.bitflyer.jp",www:"https://bitflyer.jp",doc:"https://bitflyer.jp/API"},api:{public:{get:["getmarkets/usa","getmarkets/eu","getmarkets","getboard","getticker","getexecutions","gethealth","getboardstate","getchats"]},private:{get:["getpermissions","getbalance","getcollateral","getcollateralaccounts","getaddresses","getcoinins","getcoinouts","getbankaccounts","getdeposits","getwithdrawals","getchildorders","getparentorders","getparentorder","getexecutions","getpositions","gettradingcommission"],post:["sendcoin","withdraw","sendchildorder","cancelchildorder","sendparentorder","cancelparentorder","cancelallchildorders"]}},fees:{trading:{maker:.0025,taker:.0025}}})}async fetchMarkets(){let e=await this.publicGetGetmarkets(),t=await this.publicGetGetmarketsUsa(),i=await this.publicGetGetmarketsEu(),s=this.arrayConcat(e,t);s=this.arrayConcat(s,i);let r=[];for(let e=0;e<s.length;e++){let t=s[e],i=t.product_code,a=!0,d=!1,o="spot";"alias"in t&&(o="future",d=!0,a=!1);let c=i.split("_"),n=void 0,h=void 0,l=i,p=c.length;1===p?(n=l.slice(0,3),h=l.slice(3,6)):2===p?l=(n=c[0])+"/"+(h=c[1]):(n=c[1],h=c[2]),r.push({id:i,symbol:l,base:n,quote:h,type:o,spot:a,future:d,info:t})}return r}async fetchBalance(e={}){await this.loadMarkets();let t=await this.privateGetGetbalance(),i={};for(let e=0;e<t.length;e++){let s=t[e];i[s.currency_code]=s}let s={info:t},r=Object.keys(this.currencies);for(let e=0;e<r.length;e++){let t=r[e],a=this.account();t in i&&(a.total=i[t].amount,a.free=i[t].available,a.used=a.total-a.free),s[t]=a}return this.parseBalance(s)}async fetchOrderBook(e,t,i={}){await this.loadMarkets();let s=await this.publicGetGetboard(this.extend({product_code:this.marketId(e)},i));return this.parseOrderBook(s,void 0,"bids","asks","price","size")}async fetchTicker(e,t={}){await this.loadMarkets();let i=await this.publicGetGetticker(this.extend({product_code:this.marketId(e)},t)),s=this.parse8601(i.timestamp),r=this.safeFloat(i,"ltp");return{symbol:e,timestamp:s,datetime:this.iso8601(s),high:void 0,low:void 0,bid:this.safeFloat(i,"best_bid"),bidVolume:void 0,ask:this.safeFloat(i,"best_ask"),askVolume:void 0,vwap:void 0,open:void 0,close:r,last:r,previousClose:void 0,change:void 0,percentage:void 0,average:void 0,baseVolume:this.safeFloat(i,"volume_by_product"),quoteVolume:void 0,info:i}}parseTrade(e,t){let i=void 0,s=void 0;if("side"in e&&e.side){let t=(i=e.side.toLowerCase())+"_child_order_acceptance_id";t in e&&(s=e[t])}void 0===s&&(s=this.safeString(e,"child_order_acceptance_id"));let r=this.parse8601(e.exec_date);return{id:e.id.toString(),info:e,timestamp:r,datetime:this.iso8601(r),symbol:t.symbol,order:s,type:void 0,side:i,price:e.price,amount:e.size}}async fetchTrades(e,t,i,s={}){await this.loadMarkets();let r=this.market(e),a=await this.publicGetGetexecutions(this.extend({product_code:r.id},s));return this.parseTrades(a,r,t,i)}async createOrder(e,t,i,s,r,a={}){await this.loadMarkets();let d={product_code:this.marketId(e),child_order_type:t.toUpperCase(),side:i.toUpperCase(),price:r,size:s},o=await this.privatePostSendchildorder(this.extend(d,a));return{info:o,id:o.child_order_acceptance_id}}async cancelOrder(e,i,s={}){if(void 0===i)throw new t(this.id+" cancelOrder() requires a symbol argument");return await this.loadMarkets(),await this.privatePostCancelchildorder(this.extend({product_code:this.marketId(i),child_order_acceptance_id:e},s))}parseOrderStatus(e){let t={ACTIVE:"open",COMPLETED:"closed",CANCELED:"canceled",EXPIRED:"canceled",REJECTED:"canceled"};return e in t?t[e]:e.toLowerCase()}parseOrder(e,t){let i=this.parse8601(e.child_order_date),s=this.safeFloat(e,"size"),r=this.safeFloat(e,"outstanding_size"),a=this.safeFloat(e,"executed_size"),d=this.safeFloat(e,"price"),o=d*a,c=this.parseOrderStatus(e.child_order_state),n=e.child_order_type.toLowerCase(),h=e.side.toLowerCase(),l=void 0;if(void 0===t){let i=this.safeString(e,"product_code");void 0!==i&&i in this.markets_by_id&&(t=this.markets_by_id[i])}void 0!==t&&(l=t.symbol);let p=void 0,u=this.safeFloat(e,"total_commission");return void 0!==u&&(p={cost:u,currency:void 0,rate:void 0}),{id:e.child_order_acceptance_id,info:e,timestamp:i,datetime:this.iso8601(i),lastTradeTimestamp:void 0,status:c,symbol:l,type:n,side:h,price:d,cost:o,amount:s,filled:a,remaining:r,fee:p}}async fetchOrders(e,i,s=100,r={}){if(void 0===e)throw new t(this.id+" fetchOrders() requires a symbol argument");await this.loadMarkets();let a=this.market(e),d={product_code:a.id,count:s},o=await this.privateGetGetchildorders(this.extend(d,r)),c=this.parseOrders(o,a,i,s);return e&&(c=this.filterBy(c,"symbol",e)),c}async fetchOpenOrders(e,t,i=100,s={}){return s.child_order_state="ACTIVE",this.fetchOrders(e,t,i,s)}async fetchClosedOrders(e,t,i=100,s={}){return s.child_order_state="COMPLETED",this.fetchOrders(e,t,i,s)}async fetchOrder(e,s,r={}){if(void 0===s)throw new t(this.id+" fetchOrder() requires a symbol argument");let a=await this.fetchOrders(s),d=this.indexBy(a,"id");if(e in d)return d[e];throw new i(this.id+" No order found with id "+e)}async fetchMyTrades(e,i,s,r={}){if(void 0===e)throw new t(this.id+" fetchMyTrades requires a symbol argument");await this.loadMarkets();let a=this.market(e),d={product_code:a.id};s&&(d.count=s);let o=await this.privateGetGetexecutions(this.extend(d,r));return this.parseTrades(o,a,i,s)}async withdraw(e,i,s,r,a={}){if(this.checkAddress(s),await this.loadMarkets(),"JPY"!==e&&"USD"!==e&&"EUR"!==e)throw new t(this.id+" allows withdrawing JPY, USD, EUR only, "+e+" is not supported");let d=this.currency(e),o=await this.privatePostWithdraw(this.extend({currency_code:d.id,amount:i},a));return{info:o,id:o.message_id}}sign(e,t="public",i="GET",s={},r,a){let d="/"+this.version+"/";"private"===t&&(d+="me/"),d+=e,"GET"===i&&Object.keys(s).length&&(d+="?"+this.urlencode(s));let o=this.urls.api+d;if("private"===t){this.checkRequiredCredentials();let e=this.nonce().toString(),t=[e,i,d].join("");Object.keys(s).length&&"GET"!==i&&(t+=a=this.json(s)),r={"ACCESS-KEY":this.apiKey,"ACCESS-TIMESTAMP":e,"ACCESS-SIGN":this.hmac(this.encode(t),this.encode(this.secret)),"Content-Type":"application/json"}}return{url:o,method:i,body:a,headers:r}}};
//# sourceMappingURL=bitflyer.js.map